"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Skript=void 0;var axios_1=__importDefault(require("axios"));require("weakmap-polyfill"),require("formdata-polyfill"),require("promise-polyfill");var md5_1=__importDefault(require("md5")),MMDate_1=require("./MMDate");axios_1.default.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",axios_1.default.interceptors.response.use(function(e){return"string"==typeof e.data&&-1!==(e.headers["content-type"]||"").indexOf("application/json")&&(e.data=JSON.parse(e.data)),e});var Skript=function(){function e(){this.editors={},this.isInitialized=!1,this.initializePromise=null,this._loadRouteEndpoint="/common/routes",this.ajax={_app:this,get:axios_1.default.get,post:axios_1.default.post,put:function(e,t,n){return t instanceof FormData?t.append("_method","PUT"):"object"==typeof t&&(t._method="PUT"),axios_1.default.post(e,t,n)},delete:function(e,t){return axios_1.default.post(e,{_method:"DELETE"},t)}},this.is={number:function(e){return!isNaN(Number.parseFloat(e))},array:function(e){return Array.isArray(e)},null:function(e){return null===e},undefined:function(e){return void 0===e},empty:function(e){return!!this.undefined(e)||(!!this.null(e)||(!(!this.array(e)||0!==e.length)||("object"==typeof e&&"{}"===JSON.stringify(e)||!(!this.string(e)||0!==e.replace(/\s/g,"").length))))},function:function(e){return"function"==typeof e},string:function(e){return"string"==typeof e}},this.dom={app:this,inputOnly:function(e,t,n){if(void 0===n&&(n=!1),e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){var r=function(){};switch((""+t).toLowerCase()){case"number":r=function(){this.value=this.value.replace(/[^0-9]/g,"")};break;case"korean":r=function(){this.value=this.value.replace(/[^ㄱ-ㅎ가-힣ㅏ-ㅣ\x20]/g,"")}}this.app.addAction(e,{eventType:!0===n?"keyup":"change",callback:r})}},pluckValue:function(e,r){var o=[];return document.querySelectorAll(e).forEach(function(e,t,n){"function"==typeof r&&!0!==r(e)||(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement?o.push(e.value):o.push(e.nodeValue))}),o},pluckAttribute:function(e,r,o){var a=[];return document.querySelectorAll(e).forEach(function(e,t,n){"function"==typeof o&&!0!==o(e)||a.push(e.getAttribute(r))}),a},count:function(e,t){if(!this.app.is.string(e)&&!e.length)throw new Error("'"+e+"("+typeof e+")' - 유효한 셀렉터가 아닙니다.");var n="string"==typeof e?document.querySelectorAll(e):e,r=n.length;if(this.app.is.function(t))for(var r=0,o=0;o<n.length;o++)!0===t(n[o],o)&&r++;return r},getValue:function(e,t){void 0===t&&(t=null);e=document.querySelector(e);return e&&e.value||t}},this.number={comma:function(e){e=Number.parseFloat(""+e);return isNaN(e)?"":Number.isFinite(e)?e.toLocaleString():e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}},this.str={contains:function(e,t){return-1<(e=""+e).indexOf(t=""+t)},containsAll:function(e,t){e=""+e;for(var n=0;n<t.length;n++){var r=""+t[n];if(r&&-1==e.indexOf(r))return!1}return!0},containsAny:function(e,t){e=""+e;for(var n=0;n<t.length;n++){var r=""+t[n];if(r&&-1<e.indexOf(r))return!0}return!1},endsWith:function(e,t){e=""+e;for(var n="string"==typeof t?[t]:t||[],r=0;r<n.length;r++){var o=""+(n[r]||"");if(o&&e.lastIndexOf(o)===e.length-o.length)return!0}return!1},finish:function(e,t){return this.endsWith(e=""+e,t=""+t)?e:e+t},startsWith:function(e,t){e=""+e;for(var n="string"==typeof t?[t]:t||[],r=0;r<n.length;r++){var o=""+(n[r]||"");if(o&&0===e.indexOf(o))return!0}return!1},start:function(e,t){return this.startsWith(e=""+e,t=""+t)?e:t+e},limit:function(e,t,n){return void 0===n&&(n="..."),(e=""+e).length>t?e.substr(0,t)+n:e},reverseLimit:function(e,t,n){return void 0===n&&(n="..."),(e=""+e).length>t?n+e.substr(e.length-t):e},wrap:function(e,t,n,r){return void 0===n&&(n=""),void 0===r&&(r=""),(e=""+e).split(t).join(n+t+r)},padLeft:function(e,t,n){return this.pad(e,t,n,"left")},padRight:function(e,t,n){return this.pad(e,t,n,"right")},pad:function(e,t,n,r){if(n=n||"",isNaN(t)||t<1)throw new Error("패딩 길이가 유효하지 않습니다.");if(""===n)throw new Error("패딩 문자가 지정되지 않았습니다.");if("left"!==r&&"right"!==r)throw new Error("패딩 방향이 유효하지 않습니다.");return(e=""+e).length<t?this.pad("right"===r?e+n:n+e,t,n,r):e},left:function(e,t){return e.substr(0,t)},right:function(e,t){return(e=""+e).substr(e.length-t,t)}},this.routes=[],this.md5=md5_1.default,this.pageScripts={common:{}},this.callbacks={},this.vues={},this.instanceCreatedAt=new Date}return e.prototype.getRouteParamsByName=function(t,e){var n=this.routes.find(function(e){return e.name===t});if(!n)throw new Error("해당 라우트 정보를 찾을 수 없습니다.");e=e||location.pathname;return this.getRouteParams(n.path,e)},e.prototype.getRouteParams=function(e,t){for(var t=t||location.pathname,n={},r=t.replace(/^\//,"").split("/");e.match(/\.\.\.\d/);){var o=e.match(/\.\.\.\d/);if(null!==o){for(var a=Number.parseInt(o[0].replace(/^\.\.\./,"")),i=o.index,u=[],s=0;s<a;s++)u.push("{_}");var c=e.substring(0,i),o=e.substring(i+o[0].length);e=[c,u.join("/"),o].join("")}}return e.replace(/^\//,"").split("/").forEach(function(e,t){"{_}"!==e&&e.includes("{")&&e.includes("}")&&r[t]&&(n[e.replace(/^{/,"").replace(/}$/,"")]=r[t])}),n},e.prototype.getRouteParamAt=function(e,t){t=(t||location.pathname).replace(/^\//,"").split("/");return e<0?t[t.length+e]||null:t[e]||null},e.prototype.getQueryParam=function(e,t){var t=t||location.search,t=this.getQueryParams(t),e=e.split("[").map(function(e){return e.replace(/\]$/,"")}).filter(function(e){return""!==e}),n=t;return e.forEach(function(e){null!==n&&(n=null===n[e]||void 0===n[e]?null:n[e])}),void 0===n?null:n},e.prototype.getQueryParams=function(e){var s=this,e=e||location.search,c={};return e.replace(/[^?]*\?/,"").split("&").filter(function(e){return""!==e}).map(function(e){var t=e.indexOf("="),n=[e.substr(0,t),e.substr(t+1)],e=decodeURIComponent(n[0]),r=n[1]||"",t=e.match(/\[([^\[\]]*)\]/);if(null!==t&&t.index){n=e.substring(0,t.index),t=e.substring(t.index);if("[]"===t)c[n]||(c[n]=[]),c[n]=c[n],c[n].push(s.formatQueryParamValue(r));else{c[n]||(c[n]={});for(var o=t.match(/\[([^\[\]]*)\]/g)||[],a=c[n],i=0;i<o.length;i++){var u=o[i].replace(/^\[/,"").replace(/\]$/,"");""!==u?(a[u]||(o.length>=i+1&&"[]"===o[i+1]?a[u]=[]:a[u]={}),i===o.length-1?a[u]=s.formatQueryParamValue(r):a=a[u]):(a&&Array.isArray(a)||(a=[]),""!==r&&a.push(s.formatQueryParamValue(r)))}}}else c[e]=s.formatQueryParamValue(r)}),c},e.prototype.formatQueryParamValue=function(e){return"true"===e||"false"!==e&&(e.match(/^0/)||e.match(/[^\d\.]/)||!this.is.number(e)||e!=Number.parseFloat(e).toString()?decodeURIComponent(e):Number.parseFloat(e))},e.prototype.clone=function(e){if(null===e||"object"!=typeof e)return e;var t,n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=this.clone(e[t]));return n},e.prototype.addAction=function(e,t,n){var r="function"==typeof t?{callback:t}:t||{};if(e&&r.callback&&r.callback){r.eventType=r.eventType||"click";for(var o=this.getTargetsFromSelector(e,n),a=0;a<o.length;a++)for(var i=o[a],u=r.eventType.split(","),s=0;s<u.length;s++){var c=u[s].trim();"$enter"===c?i.addEventListener("keyup",function(e){e&&"Enter"===e.key&&r.callback.call(this,o)}):"$esc"===c?i.addEventListener("keyup",function(e){!e||"Esc"!==e.key&&"Escape"!==e.key||r.callback.call(this,o)}):i.addEventListener(c,function(){r.callback.call(this,o)})}}},e.prototype.runAction=function(e,t,n){if(!(e&&t&&this.is.function(t)))throw new Error("대상 선택기준이 없거나 실행할 함수가 없습니다.");for(var r=this.getTargetsFromSelector(e,n),o=0;o<r.length;o++){var a=r[o];t.call(a,r,o)}},e.prototype.getTargetsFromSelector=function(e,t){e=e instanceof HTMLElement?[e]:e instanceof NodeList?e:"window"===e||e===window?[window]:"document"===e||e===document?[document]:"string"==typeof e?(t instanceof HTMLElement?t:document).querySelectorAll(e||"temp.not-exist-selector"):e;return e},e.prototype.querify=function(e){if("string"==typeof e)return"?"+e+"=";var t,n=[];for(t in e)e.hasOwnProperty(t)&&!function r(o,a,i){if(null!==i&&"object"==typeof i)if(Array.isArray(i))0===i.length?o.push(a+"[]="):i.forEach(function(e){if(null!==e&&"object"==typeof e)if(Array.isArray(e))r(o,a+"[]",e);else if(s(e))o.push(a+"="+encodeURIComponent(c(i)));else for(var t in e){var n;e.hasOwnProperty(t)&&(n=e[t],r(o,a+"[]["+t+"]",n))}else"function"!=typeof e&&(s(e)?o.push(a+"[]="+encodeURIComponent(c(e))):o.push(a+"[]="+encodeURIComponent(u(e))))});else if(s(i))o.push(a+"="+encodeURIComponent(c(i)));else for(var e in i){var t;i.hasOwnProperty(e)&&(t=i[e],r(o,a+"["+e+"]",t))}else"function"!=typeof i&&(s(i)?o.push(a+"="+encodeURIComponent(c(i))):o.push(a+"="+encodeURIComponent(u(i))))}(n,t,e[t]);return 0<n.length?"?"+n.join("&"):"";function u(e){return null==e?"":e}function s(e){return e&&(e.constructor===Date||"function"==typeof e.getDateInstance&&e.getDateInstance()&&e.getDateInstance().constructor===Date)}function c(e){if(null==e)return"";if(e.constructor!==Date)return"function"==typeof e.getDateInstance&&e.getDateInstance()&&(e.getDateInstance().constructor,Date),u(e);var t=e.getFullYear();if(isNaN(t))return"Invalid Date";var n=""+(e.getMonth()+1);n.length<2&&(n="0"+n);var r=""+e.getDate();r.length<2&&(r="0"+r);var o=""+e.getHours();o.length<2&&(o="0"+o);var a=""+e.getMinutes();a.length<2&&(a="0"+a);e=""+e.getSeconds();return t+"-"+n+"-"+r+" "+o+":"+a+":"+(e=e.length<2?"0"+e:e)}},e.prototype.syncQueryParamsToPage=function(u,e){var e=(e||location.search).replace(/^\?/,"").split("&"),s={};e.map(function(e){return e.split("=")}).forEach(function(e){var t=decodeURIComponent(e[0]),n=decodeURIComponent(decodeURI(e[1]).replace(/\+/g," "));if(s[t]?s[t]=s[t]+1:s[t]=1,u)for(var r in u)if(u.hasOwnProperty(r)&&"function"==typeof u[r]){var o=new RegExp(r.split("[*]").map(function(e){return e.replace(/\[/g,"\\[").replace(/\]/g,"\\]")}).join("\\[([^\\]]*)\\]")+"$");if(t.match(o))return u[r](t,n,s[t])}if(u&&u[t]&&"function"==typeof u[t])return u[t](t,n,s[t]);var e=document.querySelectorAll('[name="'+t+'"]'),a=null;if((a=1<e.length?e[s[t]-1]:e[0])instanceof HTMLInputElement)switch(a.getAttribute("type")){case"checkbox":case"radio":var i=document.querySelector('[name="'+t+'"][value="'+n+'"]');i instanceof HTMLInputElement&&(i.checked=!0);break;default:a.value=n}else(a instanceof HTMLSelectElement||a instanceof HTMLTextAreaElement)&&(a.value=n)})},e.prototype.extract=function(e,t){e=document.querySelector(e),t=t||{dataType:"json",appends:{}};if(this.is.null(e))throw new Error("대상 엘리먼트가 존재하지 않습니다.");if(!this.is.string(t.dataType))throw new Error("반환 데이터 타입이 유효하지 않습니다");if("json"===t.dataType.toLowerCase())return this.extractJson(e,t.appends);if("formdata"===t.dataType.toLowerCase())return this.extractFormData(e,t.appends);throw new Error("반환 데이터 타입이 유효하지 않습니다")},e.prototype.extractJson=function(e,t,n){for(var r=e.querySelectorAll("[name]"),o=t||{},a=0;a<r.length;a++){var i=r[a],u=-1!==(s=i.getAttribute("name")||"").indexOf("[]"),s=s.replace("[]","");if(i instanceof HTMLSelectElement&&(n||i.value&&""!=i.value))o[s]=i.value;else if(i instanceof HTMLInputElement)switch((i.getAttribute("type")||"").toLowerCase()){case"checkbox":i.checked&&(u?(o[s]=Array.isArray(o[s])?o[s]:[],o[s].push(i.value)):o[s]=i.value);break;case"radio":i.checked&&(o[s]=i.value);break;case"text":case"password":case"email":case"hidden":case"search":case"number":case"tel":case"date":case"datetime":case"datetime-local":(n||i.value&&""!=i.value)&&(u?(o[s]=Array.isArray(o[s])?o[s]:[],o[s].push(i.value)):o[s]=i.value)}else i instanceof HTMLTextAreaElement&&(n||i.value&&""!=i.value)&&(o[s]=i.value)}return o},e.prototype.extractFormData=function(e,t,n){var r,o=e.querySelectorAll("[name]"),a=t||{},i=new FormData;for(r in a)i.append(r,a[r]);for(var u=0,s={},c=0;c<o.length;c++){var l=o[c],f=l.getAttribute("name")||"",p=-1!==f.indexOf("[]");if(l instanceof HTMLSelectElement&&l.value&&""!=l.value)i.append(f,l.value);else if(l instanceof HTMLInputElement||"[object HTMLInputElement]"==Object.getPrototypeOf(l).toString()){var h=l;switch((l.getAttribute("type")||"").toLowerCase()){case"checkbox":h.checked&&(p||i.delete(f),i.append(f,h.value));break;case"radio":h.checked&&i.append(f,h.value);break;case"text":case"password":case"email":case"hidden":case"search":case"tel":case"date":case"datetime":case"datetime-local":h.value&&""!=h.value&&i.append(f,h.value);break;case"file":if(h.files&&(u+=h.files.length),n)n(i,f,h.files,h);else if(h.files&&0<h.files.length)if(1<h.files.length)for(var d=0;d<h.files.length;d++){var m=h.files[d];i.append(f+"["+d+"]",m)}else i.append(f,h.files[0])}}else l instanceof HTMLTextAreaElement&&l.value&&""!=l.value&&i.append(f,l.value)}if(0<u){var v,y={totalCount:u,files:{}};for(v in s){y.files[v]=[];for(c=0;c<s[v].length;c++){var g=s[v][c];y.files[v].push({isNew:g instanceof File,url:g instanceof File?null:(g.name||"").replace(/\?.*/,"")})}}i.append("metadata_files",JSON.stringify(y))}return i},e.prototype.wait=function(n){return new Promise(function(e){var t=window.setTimeout(function(){e(t)},1e3*n)})},e.prototype.range=function(e,t){if("number"!=typeof e)throw new Error("시작값이 없거나 숫자가 아닙니다.");if("number"!=typeof t)throw new Error("종료값이 없거나 숫자가 아닙니다.");if(t<e)throw new Error("시작값이 종료값보다 큽니다.");for(var n=[],r=e;r<=t;r++)n.push(r);return n},e.prototype.random=function(e,t,n){if(void 0===n&&(n=!0),"number"!=typeof e)throw new Error("최소값이 없거나 숫자가 아닙니다.");if("number"!=typeof t)throw new Error("최대값이 없거나 숫자가 아닙니다.");if(t<e)throw new Error("최소값이 최대값보다 큽니다.");t=t-e+1;return(!0===n?Math.floor(Math.random()*t):Math.random()*t)+e},e.prototype.groupBy=function(e,n,r){var o={};return Array.prototype.forEach.call(e,function(e){var t=e[n];-1<(""+n).indexOf(".")&&(t=e,n.split(".").forEach(function(e){t=t[e]||""})),"function"==typeof r&&(t=r(t)),o[t]?o[t].push(e):o[t]=[e]}),o},e.prototype.tick=function(n){return{intervalId:-1,count:1,tester:function(){return!0},endHandler:function(){},do:function(e){var t=this;return this.intervalId=window.setInterval(function(){!1===t.tester()?(clearInterval(t.intervalId),t.endHandler()):e(t.count++)},1e3*n),this},until:function(e){return"function"==typeof e&&(this.tester=e),this},whenEnd:function(e){return"function"==typeof e&&(this.endHandler=e),this}}},e.prototype.runWhenReady=function(e,o,a,t){void 0===a&&(a=0),void 0===t&&(t=1);var i="string"==typeof e||"function"==typeof e?[e]:e,u=0,s=setInterval(function(){0<a&&a<u&&clearInterval(s);for(var e=0;e<i.length;e++)if("function"==typeof i[e])try{if(!0!==i[e]())return void u++}catch(e){console.error(e),clearInterval(s)}else{if("string"!=typeof i[e])throw clearInterval(s),new Error("Unexpected Type ["+typeof i[e]+"] : 문자열 또는 boolean을 반환하는 함수여야합니다.");for(var t=i[e].split("."),n=window[t[0]],r=1;r<t.length;r++)if(null==(n=n[t[r]]))return void u++;if(null==n)return void u++}try{o()}catch(e){console.error(e)}finally{clearInterval(s)}},1e3*t)},e.prototype.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},e.prototype.setServerNowDatetime=function(e){var t;if("string"==typeof e){if(t=new Date(e),isNaN(t.getTime()))throw new Error("Date 타입으로 변환할 수 없습니다. ("+e+")")}else t=e;var n=(new Date).getTime()-this.instanceCreatedAt.getTime(),e=this.instanceCreatedAt.getTime()-t.getTime();this.diffInTimeServerToScript=n+e,this.serverNowDatetime=t},e.prototype.countdown=function(e,t,n,r){var o,a=this;if(void 0===r&&(r=!1),"string"==typeof e){if(o=new Date(e),isNaN(o.getTime()))throw new Error("Date 타입으로 변환할 수 없습니다. ("+e+")")}else o=e;var i=o.getTime(),u=1;switch(t.toLowerCase()){case"s":case"second":case"seconds":break;case"ms":case"millisecond":case"milliseconds":u=.001;break;case"m":case"minute":case"minutes":u=60;break;case"h":case"hour":case"hours":u=3600}return!0===r&&(r=i-Date.now(),n(r,{hour:Math.floor(r/1e3/60/60),minute:Math.floor(r/1e3/60)%60,second:Math.floor(r/1e3)%60})),new Promise(function(e,t){try{a.tick(u).do(function(){var e=i-Date.now();n(e,{hour:Math.floor(e/1e3/60/60),minute:Math.floor(e/1e3/60)%60,second:Math.floor(e/1e3)%60})}).until(function(){return i>Date.now()}).whenEnd(function(){e()})}catch(e){t(e)}})},e.prototype.loadRoutes=function(){var n=this;return new Promise(function(t,e){n.ajax.get(n._loadRouteEndpoint).then(function(e){t(e.data.routeList)}).catch(e)})},e.prototype.route=function(t,n){var e=this.routes.find(function(e){return e.name===t});if(void 0===e)throw new Error("해당 라우트를 찾을 수 없습니다.");var r=e.path,o=[];if(Array.isArray(e.routeParameters)){e.routeParameters.filter(function(e){return!1===e.isOptional}).forEach(function(e){if(null===(n||{})[e.name]||void 0===(n||{})[e.name])throw new Error("필수 파라미터("+e.name+")가 누락되었습니다.")});for(var a=r.match(/{([^}]*)}/);a;){o.push(a[1]);var i=(n||{})[a[1]],a=(r=r.replace(a[0],i)).match(/{([^}]*)}/)}}var u=[];if(n)for(var s in n)!function(t){n.hasOwnProperty(t)&&void 0===o.find(function(e){return e===t})&&u.push(t+"="+n[t])}(s);e="/"+r.replace(/^\//,"").replace(/\/$/,"");return e=0<u.length?e+"?"+u.join("&"):e},e.prototype.init=function(r){var o=this;return null!==this.initializePromise||(this.initializePromise=new Promise(function(e,t){try{var n;o.isInitialized?"complete"==document.readyState?e(o):window.addEventListener("load",function(){e(o)}):(n=!0,sessionStorage.getItem("routes")&&sessionStorage.getItem("routeFetchedAt")&&!(new MMDate_1.MMDate).isAfterOrEqual(new MMDate_1.MMDate(sessionStorage.getItem("routeFetchedAt")).after(5,"minutes"),"minutes")||(n=!1),(n?Promise.resolve().then(function(){o.routes=JSON.parse(sessionStorage.getItem("routes"))}):o.loadRoutes().then(function(e){sessionStorage.setItem("routes",JSON.stringify(e)),sessionStorage.setItem("routeFetchedAt",(new MMDate_1.MMDate).format()),o.routes=e})).then(function(){r&&"function"==typeof r&&r(o),o.isInitialized=!0,"complete"==document.readyState?e(o):window.addEventListener("load",function(){e(o)})}).catch(t))}catch(e){t(e)}})),this.initializePromise},e}();exports.Skript=Skript;